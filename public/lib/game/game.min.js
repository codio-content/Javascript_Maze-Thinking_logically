"use strict";function useCountryArt(){setTilesheet({src:"img/country.png",font:"consolas",fontColor:"#000000",ts:50,wall:{x:0,y:0},floor:{x:1,y:0},player:{x:0,y:0},monster:{x:0,y:0},energy:{x:0,y:0},goal:{x:0,y:0}})}function useDerekArt(){setTilesheet({src:"img/derek64.png",font:"Georgia",fontColor:"#FFFFFF",ts:64,wall:{x:6,y:1},floor:{x:1,y:0},player:{x:0,y:4},monster:{x:11,y:5},energy:{x:0,y:9},goal:{x:2,y:0}})}function setTilesheet(s){art=s,art.image=new Image,art.image.src=art.src,ts=art.ts}function createSounds(){sound=jsfxlib.createWaves({wall:["saw",0,.4,0,.096,0,.136,20,251,2400,-.476,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0],monster:["saw",0,.4,0,.08,0,.186,20,933,2400,-.696,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0],energy:["square",0,.4,0,.094,.471,.298,20,1077,2400,0,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0],goal:["square",0,.4,0,.14,0,.282,20,653,2400,.466,0,0,.01,3e-4,0,0,0,.431,0,.7856,0,0,1,0,0,0,0]})}function resizeCanvas(){canvas.width=ts*mazeWidth,canvas.height=ts*mazeHeight}function resetKeys(){for(var key in keyNow)keyOld[key]=!1,keyNow[key]=!1}function keyevent(e){keyMap[e.which]&&(keyNow[keyMap[e.which]]="keydown"==e.type)}function update(delta){for(var i=0;i<entities.length;i++)entities[i].update();for(var key in keyNow)keyOld[key]=keyNow[key];for(var i=0;i<entities.length;i++)entities[i].remove||entities[i].render();for(var i=entities.length-1;i>=0;i--)if(entities[i].remove){var e=entities[i];entities.splice(i,1),tiles[e.x][e.y].entity=null}}function render(){context.clearRect(0,0,canvas.width,canvas.height);for(var x=0;mazeWidth>x;x++)for(var y=0;mazeHeight>y;y++)if(art[tiles[x][y].type]){var q=art[tiles[x][y].type];context.drawImage(art.image,q.x*ts,q.y*ts,ts,ts,x*ts,y*ts,ts,ts)}for(var i=0;i<entities.length;i++)entities[i].render();if(gridInfo){context.strokeStyle="#FFFFFF",context.fillStyle="#FFFFFF",context.font="12px Consolas";for(var x=0;mazeWidth>x;x++)for(var y=0;mazeHeight>y;y++)art[tiles[x][y].type]&&(context.strokeRect(x*ts,y*ts,ts,ts),context.fillText("("+x+","+y+")",x*ts+5,y*ts+17))}context.fillStyle=art.fontColor,context.font=Math.round(ts/2)+"px "+art.font,context.fillText("steps: "+steps,Math.round(ts/3),Math.round(ts/1.5)),context.fillText("energy: "+energy,3.1*ts,Math.round(ts/1.5)),context.fillText("score: "+Math.floor(score),6.5*ts,Math.round(ts/1.5)),message&&(context.font=Math.round(ts/2)+"px "+art.font,context.fillText(message,Math.round(ts/3),mazeHeight*ts-Math.round(ts/3)))}function tickBrowser(t){update(t-timestamp),render(),timestamp=t,setTimeout(function(){requestAnimationFrame(tickBrowser)},timeout)}function getEmptyTile(attempts){attempts=attempts||50;for(var i=0;attempts>i;){var x=Math.floor(Math.random()*(mazeWidth-4)+2),y=Math.floor(Math.random()*(mazeHeight-4)+2);if("floor"==tiles[x][y].type&&!tiles[x][y].entity)return tiles[x][y];i++}for(var x=0;mazeWidth>x;x++)for(var y=0;mazeHeight>y;y++)if("floor"==tiles[x][y].type&&!tiles[x][y].entity)return tiles[x][y];return null}function keyPressed(name){return keyNow[name]&&!keyOld[name]}function addWall(x,y){if(!x&&!y){var tile=getEmptyTile();return tile?(tile.type="wall",!0):!1}return x>0&&mazeWidth-1>x&&y>0&&mazeHeight-1>y&&!tiles[x][y].entity?(tiles[x][y].type="wall",!0):!1}function addRandomWalls(n){n||(n=Math.floor(mazeWidth*mazeHeight/15)),n>50&&(n=50);for(var i=0;n>i;i++)addWall()}function addEntity(e,x,y){return x>0&&mazeWidth-1>x&&y>0&&mazeHeight-1>y&&!tiles[x][y].entity?(tiles[x][y].type="floor",entities.push(e),tiles[x][y].entity=e,e.x=x,e.y=y,e):null}function removeObject(object){object.remove=!0}function addPlayer(x,y){for(var i=0;i<entities.length;i++)if("player"==entities[i].type){tiles[entities[i].x][entities[i].y].entity=null,entities.splice(i,1),player=null;break}return x||y?x>0&&mazeWidth-1>x&&y>0&&mazeHeight-1>y?(tiles[x][y].entity&&(entities.splice(entities.indexOf(tiles[x][y].entity),1),tiles[x][y].entity=null),player=new Player,addEntity(player,x,y)):null:addPlayer(1,mazeHeight-2)}function addGoal(x,y){return x||y?x>0&&mazeWidth-1>x&&y>0&&mazeHeight-1>y?(tiles[x][y].entity&&(entities.splice(entities.indexOf(tiles[x][y].entity),1),tiles[x][y].entity=null),addEntity(new Goal,x,y)):null:addGoal(mazeWidth-2,1)}function addMonster(x,y){if(!x&&!y){var tile=getEmptyTile();return tile?addEntity(new Monster,tile.x,tile.y):null}return addEntity(new Monster,x,y)}function addRandomMonsters(n){n||(n=Math.floor(mazeWidth*mazeHeight/30)),n>50&&(n=50);for(var i=0;n>i;i++)addMonster()}function addEnergy(x,y){if(!x&&!y){var tile=getEmptyTile();return tile?addEntity(new Energy,tile.x,tile.y):null}return addEntity(new Energy,x,y)}function addRandomEnergies(n){n||(n=Math.floor(mazeWidth*mazeHeight/20)),n>50&&(n=50);for(var i=0;n>i;i++)addEnergy()}function showMessage(m){message=m}function playSound(name){sound[name]&&sound[name].play()}function resetMaze(){resetKeys(),tiles=[],entities=[],player=null,steps=1,energy=10,score=5*energy/steps,message="",mazeWidth=0,mazeHeight=0}function createEmptyMaze(width,height){width=width||mazeWidth||16,height=height||mazeHeight||8,resetMaze(),mazeWidth=width,mazeHeight=height,tiles=[mazeWidth];for(var x=0;mazeWidth>x;x++){tiles[x]=[mazeHeight];for(var y=0;mazeHeight>y;y++){var type="floor";(0===x||x==mazeWidth-1||0===y||y==mazeHeight-1)&&(type="wall"),tiles[x][y]={x:x,y:y,type:type}}}resizeCanvas()}function createRandomMaze(w,h){createEmptyMaze(w,h),addRandomWalls(),addRandomMonsters(),addRandomEnergies(),addPlayer(),addGoal()}function playerUpdate(fn){Player.prototype.update=fn}function playerHitObject(fn){Player.prototype.collisionHook=fn}function playerHitWall(fn){Player.prototype.wallCollisionEvent=fn}function playerHitMonster(fn){Player.prototype.monsterCollisionEvent=fn}function playerHitEnergy(fn){Player.prototype.energyCollisionEvent=fn}function playerHitGoal(fn){Player.prototype.goalCollisionEvent=fn}function playerStepTaken(fn){Player.prototype.stepEvent=fn}function countEntitiesOfType(type){for(var count=0,i=0;i<entities.length;i++)entities[i].type==type&&count++;return count}function getMonsterCount(){return countEntitiesOfType("monster")}function getEnergyCount(){return countEntitiesOfType("energy")}function getGoalCount(){return countEntitiesOfType("goal")}function getWallCount(){for(var count=0,x=1;mazeWidth-1>x;x++)for(var y=1;mazeHeight-1>y;y++)"wall"==tiles[x][y].type&&count++;return count}function Entity(){}function Player(){Entity.call(this)}function Monster(){Entity.call(this)}function Energy(){Entity.call(this)}function Goal(){Entity.call(this)}var audio={};(function(samplerate){this.SampleRate=samplerate||44100;var SampleRate=this.SampleRate,BitsPerSample=16,NumChannels=1,BlockAlign=NumChannels*BitsPerSample>>3,ByteRate=SampleRate*BlockAlign,chr=String.fromCharCode,waveTag="data:audio/wav;base64,",constructWave=function(data){var l;return pack(["RIFF",36+(l=data.length),"WAVEfmt ",16,1,NumChannels,SampleRate,ByteRate,BlockAlign,BitsPerSample,"data",l,data],"s4s4224422s4s")};this.make=function(arr){return new Audio(waveTag+btoa(constructWave(arrayToData(arr))))},this.makeWaveFile=function(arr){dataToFile(waveTag+btoa(constructWave(arrayToData(arr))))};var out,i,istr=function(a,i){var m8=255;return i?chr(a&m8)+istr(a>>8,i-1):""},pack=function(data,format){var out="";for(i=0;i<data.length;i++)out+="s"==format[i]?data[i]:istr(data[i],format.charCodeAt(i)-48);return out},dataToFile=function(data){document.location.href=data},sin=Math.sin,TAU=2*Math.PI,Arr=function(c){return new Array(0|c)};this.toTime=function(a){return a/SampleRate},this.toSamples=function(a){return a*SampleRate};var arrayToData16bit=function(arr){var out="",len=arr.length;for(i=0;len>i;i++){var a=32767*arr[i]|0;a=-32768>a?-32768:a>32767?32767:a,a+=0>a?65536:0,out+=String.fromCharCode(255&a,a>>8)}return out},arrayToData8bit=function(arr){var out="",len=arr.length;for(i=0;len>i;i++){var a=127*arr[i]+128|0;a=0>a?0:a>255?255:a,out+=String.fromCharCode(a)}return out},arrayToData=function(arr){return 16==BitsPerSample?arrayToData16bit(arr):arrayToData8bit(arr)};this.adjustVolume=function(data,v){for(i=0;i<data.length;i++)data[i]*=v;return data},this.filter=function(data,func,from,to,A,B,C,D,E,F){for(from=from?from:1,to=to?to:data.length,out=data.slice(0),i=from;to>i;i++)out[i]=func(data,out,from,to,i,A,B,C,D,E,F);return out};var filter=this.filter;this.filters={lowpass:function(data,out,from,to,pos,A){return out[pos-1]+A*(data[pos]-out[pos-1])},lowpassx:function(data,out,from,to,pos,A){return out[pos-1]+A*(to-pos)/(to-from)*(data[pos]-out[pos-1])},highpass:function(data,out,from,to,pos,A){return A*(out[pos-1]+data[pos]-data[pos-1])}};var filters=this.filters;this.f={lowpass:function(data,from,to,A){return filter(data,filters.lowpass,from,to,A)},lowpassx:function(data,from,to,A){return filter(data,filters.lowpassx,from,to,A)},highpass:function(data,from,to,A){return filter(data,filters.highpass,from,to,A)}},this.generate=function(count,freq,func,A,B,C,D,E,F){var sfreq=freq*TAU/SampleRate,out=Arr(count);for(i=0;count>i;i++)out[i]=func(i*sfreq,A,B,C,D,E,F);return out};var lastNoise=0,generate=this.generate;this.generators={noise:function(phase){return 4>phase%TAU&&(lastNoise=2*Math.random()-1),lastNoise},uninoise:Math.random,sine:Math.sin,synth:function(phase){return sin(phase)+.5*sin(phase/2)+.3*sin(phase/4)},saw:function(phase){return 2*(phase/TAU-(phase/TAU+.5|0))},triangle:function(phase){return Math.abs(4*((phase/TAU-.25)%1)-2)-1},square:function(phase,A){return sin(phase)>A?1:sin(phase)<A?-1:A}};var generators=this.generators;this.g={noise:function(count){return generate(count,0,generators.noise)},sine:function(count,freq){return generate(count,freq,generators.sine)},synth:function(count,freq){return generate(count,freq,generators.synth)},saw:function(count,freq){return generate(count,freq,generators.saw)},triangle:function(count,freq){return generate(count,freq,generators.triangle)},square:function(count,freq,A){return generate(count,freq,generators.square,A)}}}).apply(audio);var jsfx={};(function(){this.Parameters=[],this.Generators={square:audio.generators.square,saw:audio.generators.saw,triangle:audio.generators.triangle,sine:audio.generators.sine,noise:audio.generators.noise,synth:audio.generators.synth},this.getGeneratorNames=function(){var names=[];for(var e in this.Generators)names.push(e);return names};var nameToParam=function(name){return name.replace(/ /g,"")};this.getParameters=function(){var params=[],grp=0,ap=function(name,min,max,def,step){void 0===step&&(step=(max-min)/1e3);var param={name:name,id:nameToParam(name),min:min,max:max,step:step,def:def,type:"range",group:grp};params.push(param)},ao=function(name,options,def){var param={name:name,id:nameToParam(name),options:options,def:def,type:"option",group:grp};params.push(param)},gens=this.getGeneratorNames();return ao("Generator",gens,gens[0]),ap("Super Sampling Quality",0,16,0,1),ap("Master Volume",0,1,.4),grp++,ap("Attack Time",0,1,.1),ap("Sustain Time",0,2,.3),ap("Sustain Punch",0,3,2),ap("Decay Time",0,2,1),grp++,ap("Min Frequency",20,2400,0,1),ap("Start Frequency",20,2400,440,1),ap("Max Frequency",20,2400,2e3,1),ap("Slide",-1,1,0),ap("Delta Slide",-1,1,0),grp++,ap("Vibrato Depth",0,1,0),ap("Vibrato Frequency",.01,48,8),ap("Vibrato Depth Slide",-.3,1,0),ap("Vibrato Frequency Slide",-1,1,0),grp++,ap("Change Amount",-1,1,0),ap("Change Speed",0,1,.1),grp++,ap("Square Duty",0,.5,0),ap("Square Duty Sweep",-1,1,0),grp++,ap("Repeat Speed",0,.8,0),grp++,ap("Phaser Offset",-1,1,0),ap("Phaser Sweep",-1,1,0),grp++,ap("LP Filter Cutoff",0,1,1),ap("LP Filter Cutoff Sweep",-1,1,0),ap("LP Filter Resonance",0,1,0),ap("HP Filter Cutoff",0,1,0),ap("HP Filter Cutoff Sweep",-1,1,0),params},this.generate=function(params){var TAU=2*Math.PI,sin=Math.sin,pow=(Math.cos,Math.pow),abs=Math.abs,SampleRate=audio.SampleRate,super_sampling_quality=0|params.SuperSamplingQuality;1>super_sampling_quality&&(super_sampling_quality=1),SampleRate*=super_sampling_quality;for(var _ss=1+params.SustainPunch,envelopes=[{from:0,to:1,time:params.AttackTime},{from:_ss,to:1,time:params.SustainTime},{from:1,to:0,time:params.DecayTime}],envelopes_len=envelopes.length,i=0;envelopes_len>i;i++)envelopes[i].samples=1+(envelopes[i].time*SampleRate|0);for(var envelope=void 0,envelope_cur=0,envelope_idx=-1,envelope_increment=0,envelope_last=-1,totalSamples=0,i=0;envelopes_len>i;i++)totalSamples+=envelopes[i].samples;SampleRate/2>totalSamples&&(totalSamples=SampleRate/2);var outSamples=totalSamples/super_sampling_quality|0,out=new Array(outSamples),sample=0,sample_accumulator=0,generator=jsfx.Generators[params.Generator];void 0===generator&&(generator=this.Generators.square);var generator_A=0,generator_B=0;generator_A=params.SquareDuty;var square_slide=params.SquareDutySweep/SampleRate,phase=0,phase_speed=params.StartFrequency*TAU/SampleRate,phase_slide=1+64*pow(params.Slide,3)/SampleRate,phase_delta_slide=pow(params.DeltaSlide,3)/(1e3*SampleRate);void 0!==super_sampling_quality&&(phase_delta_slide/=super_sampling_quality),params.MinFrequency>params.StartFrequency&&(params.MinFrequency=params.StartFrequency),params.MaxFrequency<params.StartFrequency&&(params.MaxFrequency=params.StartFrequency);var phase_min_speed=params.MinFrequency*TAU/SampleRate,phase_max_speed=params.MaxFrequency*TAU/SampleRate,vibrato_phase=0,vibrato_phase_speed=params.VibratoFrequency*TAU/SampleRate,vibrato_amplitude=params.VibratoDepth,vibrato_phase_slide=1+3*pow(params.VibratoFrequencySlide,3)/SampleRate,vibrato_amplitude_slide=params.VibratoDepthSlide/SampleRate,arpeggiator_time=0,arpeggiator_limit=params.ChangeSpeed*SampleRate,arpeggiator_mod=pow(params.ChangeAmount,2);arpeggiator_mod=params.ChangeAmount>0?1+10*arpeggiator_mod:1-.9*arpeggiator_mod;for(var phaser_max=1024,phaser_mask=1023,phaser_buffer=new Array(phaser_max),_i=0;phaser_max>_i;_i++)phaser_buffer[_i]=0;var phaser_pos=0,phaser_offset=pow(params.PhaserOffset,2)*(phaser_max-4),phaser_offset_slide=4e3*pow(params.PhaserSweep,3)/SampleRate,phaser_enabled=abs(phaser_offset_slide)>1e-5||abs(phaser_offset)>1e-5,filters_enabled=params.HPFilterCutoff>.001||params.LPFilterCutoff<.999,lowpass_pos=0,lowpass_pos_slide=0,lowpass_cutoff=pow(params.LPFilterCutoff,3)/10,lowpass_cutoff_slide=1+params.HPFilterCutoffSweep/1e4,lowpass_damping=5/(1+20*pow(params.LPFilterResonance,2))*(.01+params.LPFilterCutoff);lowpass_damping>.8&&(lowpass_damping=.8),lowpass_damping=1-lowpass_damping;var lowpass_enabled=params.LPFilterCutoff<.999,highpass_accumulator=0,highpass_cutoff=pow(params.HPFilterCutoff,2)/10,highpass_cutoff_slide=1+params.HPFilterCutoffSweep/1e4,repeat_time=0,repeat_limit=totalSamples;params.RepeatSpeed>0&&(repeat_limit=pow(1-params.RepeatSpeed,2)*SampleRate+32);for(var master_volume=params.MasterVolume,k=0,i=0;totalSamples>i;i++){sample=generator(phase,generator_A,generator_B),generator_A+=square_slide,0>generator_A?generator_A=0:generator_A>.5&&(generator_A=.5),repeat_time>repeat_limit&&(phase=0,phase_speed=params.StartFrequency*TAU/SampleRate,phase_slide=1+3*pow(params.Slide,3)/SampleRate,phase_delta_slide=pow(params.DeltaSlide,3)/(1e3*SampleRate),void 0!==super_sampling_quality&&(phase_delta_slide/=super_sampling_quality),arpeggiator_time=0,arpeggiator_limit=params.ChangeSpeed*SampleRate,arpeggiator_mod=1+(0|params.ChangeAmount)/12,repeat_time=0),repeat_time+=1,phase+=phase_speed,phase_slide+=phase_delta_slide,phase_speed*=phase_slide,arpeggiator_time>arpeggiator_limit&&(phase_speed*=arpeggiator_mod,arpeggiator_limit=totalSamples),arpeggiator_time+=1,phase_speed>phase_max_speed?phase_speed=phase_max_speed:phase_min_speed>phase_speed&&(phase_speed=phase_min_speed),vibrato_phase+=vibrato_phase_speed;var _vibrato_phase_mod=phase_speed*sin(vibrato_phase)*vibrato_amplitude;if(phase+=_vibrato_phase_mod,vibrato_phase_speed*=vibrato_phase_slide,vibrato_amplitude_slide&&(vibrato_amplitude+=vibrato_amplitude_slide,0>vibrato_amplitude?(vibrato_amplitude=0,vibrato_amplitude_slide=0):vibrato_amplitude>1&&(vibrato_amplitude=1,vibrato_amplitude_slide=0)),filters_enabled){abs(highpass_cutoff)>.001&&(highpass_cutoff*=highpass_cutoff_slide,1e-5>highpass_cutoff?highpass_cutoff=1e-5:highpass_cutoff>.1&&(highpass_cutoff=.1));var _lowpass_pos_old=lowpass_pos;lowpass_cutoff*=lowpass_cutoff_slide,0>lowpass_cutoff?lowpass_cutoff=0:lowpass_cutoff>.1&&(lowpass_cutoff=.1),lowpass_enabled?(lowpass_pos_slide+=(sample-lowpass_pos)*lowpass_cutoff,lowpass_pos_slide*=lowpass_damping):(lowpass_pos=sample,lowpass_pos_slide=0),lowpass_pos+=lowpass_pos_slide,highpass_accumulator+=lowpass_pos-_lowpass_pos_old,highpass_accumulator*=1-highpass_cutoff,sample=highpass_accumulator}if(phaser_enabled){phaser_offset+=phaser_offset_slide,0>phaser_offset&&(phaser_offset=-phaser_offset,phaser_offset_slide=-phaser_offset_slide),phaser_offset>phaser_mask&&(phaser_offset=phaser_mask,phaser_offset_slide=0),phaser_buffer[phaser_pos]=sample;var _p=phaser_pos-(0|phaser_offset)+phaser_max&phaser_mask;sample+=phaser_buffer[_p],phaser_pos=phaser_pos+1&phaser_mask}i>envelope_last&&(envelope_idx+=1,envelope=envelopes_len>envelope_idx?envelopes[envelope_idx]:{from:0,to:0,samples:totalSamples},envelope_cur=envelope.from,envelope_increment=(envelope.to-envelope.from)/(envelope.samples+1),envelope_last+=envelope.samples),sample*=envelope_cur,envelope_cur+=envelope_increment,sample*=master_volume,super_sampling_quality>1?(sample_accumulator+=sample,(i+1)%super_sampling_quality===0&&(out[k]=sample_accumulator/super_sampling_quality,k+=1,sample_accumulator=0)):out[i]=sample}for(var len=SampleRate/100|0,padding=new Array(len),i=0;len>i;i++)padding[i]=0;return padding.concat(out).concat(padding)},this.Parameters=this.getParameters()}).apply(jsfx);var jsfxlib={};(function(){this.createWaves=function(lib){var sounds={};for(var e in lib){var data=lib[e];sounds[e]=this.createWave(data)}return sounds},this.createWave=function(lib){var params=this.arrayToParams(lib),data=jsfx.generate(params),wave=audio.make(data);return wave},this.paramsToArray=function(params){for(var pararr=[],len=jsfx.Parameters.length,i=0;len>i;i++)pararr.push(params[jsfx.Parameters[i].id]);return pararr},this.arrayToParams=function(pararr){for(var params={},len=jsfx.Parameters.length,i=0;len>i;i++)params[jsfx.Parameters[i].id]=pararr[i];return params}}).apply(jsfxlib);var keyMap={13:"ENTER",16:"SHIFT",17:"CTRL",18:"ALT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"},canvas=null,context=null,keyNow={},keyOld={},timeout=40,timestamp=0,ts=null,tiles=null,entities=[],player=null,message="",art={},sound={},gridInfo=!1,mazeWidth=0,mazeHeight=0,steps=1,energy=10,score=5*energy/steps;Entity.prototype.type="",Entity.prototype.x=0,Entity.prototype.y=0,Entity.prototype.update=function(delta){},Entity.prototype.render=function(){var q=art[this.type];context.drawImage(art.image,q.x*ts,q.y*ts,ts,ts,this.x*ts,this.y*ts,ts,ts)},Entity.prototype.moveUp=function(){message="",this.y-1>=0&&"wall"==tiles[this.x][this.y-1].type?this.collisionEvent(tiles[this.x][this.y-1]):tiles[this.x][this.y-1].entity?this.collisionEvent(tiles[this.x][this.y-1].entity):(tiles[this.x][this.y].entity=null,tiles[this.x][this.y-1].entity=this,this.y--,this.stepEvent())},Entity.prototype.moveDown=function(){message="",this.y+1<mazeHeight&&"wall"==tiles[this.x][this.y+1].type?this.collisionEvent(tiles[this.x][this.y+1]):tiles[this.x][this.y+1].entity?this.collisionEvent(tiles[this.x][this.y+1].entity):(tiles[this.x][this.y].entity=null,tiles[this.x][this.y+1].entity=this,this.y++,this.stepEvent())},Entity.prototype.moveleft=function(){message="",this.x-1>=0&&"wall"==tiles[this.x-1][this.y].type?this.collisionEvent(tiles[this.x-1][this.y]):tiles[this.x-1][this.y].entity?this.collisionEvent(tiles[this.x-1][this.y].entity):(tiles[this.x][this.y].entity=null,tiles[this.x-1][this.y].entity=this,this.x--,this.stepEvent())},Entity.prototype.moveRight=function(){message="",this.x+1<mazeWidth&&"wall"==tiles[this.x+1][this.y].type?this.collisionEvent(tiles[this.x+1][this.y]):tiles[this.x+1][this.y].entity?this.collisionEvent(tiles[this.x+1][this.y].entity):(tiles[this.x][this.y].entity=null,tiles[this.x+1][this.y].entity=this,this.x++,this.stepEvent())},Entity.prototype.collisionHook=function(object){},Entity.prototype.collisionEvent=function(object){this.collisionHook(object)||("wall"==object.type?this.wallCollisionEvent(object):"player"==object.type?this.playerCollisionEvent(object):"monster"==object.type?this.monsterCollisionEvent(object):"energy"==object.type?this.energyCollisionEvent(object):"goal"==object.type&&this.goalCollisionEvent(object))},Entity.prototype.wallCollisionEvent=function(object){},Entity.prototype.playerCollisionEvent=function(object){},Entity.prototype.monsterCollisionEvent=function(object){},Entity.prototype.energyCollisionEvent=function(object){},Entity.prototype.goalCollisionEvent=function(object){},Player.prototype=Object.create(Entity.prototype),Player.prototype.type="player",Player.prototype.update=function(){keyPressed("LEFT")?this.moveleft():keyPressed("RIGHT")?this.moveRight():keyPressed("UP")?this.moveUp():keyPressed("DOWN")&&this.moveDown()},Player.prototype.wallCollisionEvent=function(object){playSound("wall"),showMessage("you bash into a wall")},Player.prototype.energyCollisionEvent=function(object){playSound("energy"),showMessage("you collect some needed energy"),energy+=3,score=5*energy/steps,removeObject(object)},Player.prototype.monsterCollisionEvent=function(object){playSound("monster"),showMessage("you hit a monster"),energy+=1,score=5*energy/steps,removeObject(object)},Player.prototype.goalCollisionEvent=function(goal){playSound("goal"),showMessage("you have found the exit")},Player.prototype.stepEvent=function(object){steps++,score=5*energy/steps},Monster.prototype=Object.create(Entity.prototype),Monster.prototype.type="monster",Energy.prototype=Object.create(Entity.prototype),Energy.prototype.type="energy",Goal.prototype=Object.create(Entity.prototype),Goal.prototype.type="goal",document.addEventListener("DOMContentLoaded",function(){var container=document.body,element=document.getElementById("game");element&&(container=element),canvas=document.createElement("canvas"),container.appendChild(canvas),context=canvas.getContext("2d"),document.addEventListener("keydown",keyevent),document.addEventListener("keyup",keyevent),createSounds(),useDerekArt(),createRandomMaze(),tickBrowser()});